<?php

/**
 * Copyright Â© Two.inc All rights reserved.
 * See COPYING.txt for license details.
 */

declare(strict_types=1);

use Hyva\Theme\ViewModel\HyvaCsp;

/** @var HyvaCsp $hyvaCsp */
?>
<script>
    /**
     * Track initialization state to prevent duplicate order intents
     */
    let paymentFieldsInitialized = false;

    /**
     * Check if billing address is set to be the same as shipping address.
     * This respects Hyva Checkout's billingAsShipping checkbox state.
     */
    const isBillingAsShipping = () => {
        const checkbox = document.querySelector('#billing-as-shipping');
        return checkbox ? checkbox.checked : true; // Default to true if checkbox not found
    };

    /**
     * Update payment fields with company data and handle event synchronization.
     * Only updates if billing is same as shipping OR if forceUpdate is true.
     */
    const updatePaymentFields = (companyName, companyId, triggerOrderIntent = false, forceUpdate = false) => {
        // Only sync if billing is same as shipping, unless force update is requested
        if (!forceUpdate && !isBillingAsShipping()) {
            return;
        }
        const companyNameInput = document.querySelector('[data-name="company_name"]');
        const companyIdInput = document.querySelector('[data-name="company_id"]');

        if (companyNameInput && companyIdInput) {
            // Update DOM elements
            companyNameInput.value = companyName;
            companyIdInput.disabled = false;
            companyIdInput.value = companyId;
            companyIdInput.disabled = true;
            companyIdInput.style.backgroundColor = "#D3D3D3";

            // Sync with Alpine.js component using event dispatch
            const alpineComponent = companyNameInput.closest('[x-data]');
            if (alpineComponent) {
                alpineComponent.dispatchEvent(new CustomEvent('update-company-data', {
                    detail: {
                        companyName,
                        companyId
                    }
                }));
            }

            // Update saved company details
            const updatedCompanyDetails = {
                company_name: companyName,
                company_id: companyId
            };
            hyva.getBrowserStorage().setItem('already_saved_company_details', JSON.stringify(updatedCompanyDetails));

            // Trigger order intent if requested
            if (triggerOrderIntent) {
                window.dispatchEvent(new Event("dispatch-order-intent"));
            }
        }
    };

    document.addEventListener("DOMContentLoaded", () => {

        /**
         * Initialize previously saved company details only if it doesn't exist.
         * This preserves company information across page reloads while allowing clean state for new sessions.
         */
        if (!hyva.getBrowserStorage().getItem('already_saved_company_details')) {
            hyva.getBrowserStorage().setItem('already_saved_company_details', JSON.stringify({}));
        }

        /**
         * Initialize payment fields with persisted shipping company data on page load.
         * This ensures payment section reflects the current shipping selection after page refresh.
         */
        const initializePaymentFieldsFromShipping = () => {
            const shippingCompanySelectionData = JSON.parse(hyva.getBrowserStorage().getItem('shipping_company_selection') || "{}");
            const shippingCompany = shippingCompanySelectionData.company_name || "";
            const shippingCompanyId = shippingCompanySelectionData.company_id || "";

            // Also check if shipping field has persisted data (backend persistence)
            const shippingField = document.getElementById('shipping-company');
            const persistedShippingValue = shippingField ? shippingField.value : "";


            if (shippingCompany && shippingCompanyId) {
                // Use stored shipping selection data
                updatePaymentFields(shippingCompany, shippingCompanyId);
                paymentFieldsInitialized = true;
            } else if (persistedShippingValue) {
                // If shipping field has persisted value but no storage data,
                // we should restore the storage data for consistency
                const shippingCompanyIdField = document.getElementById('shipping-company_id');
                const persistedShippingIdValue = shippingCompanyIdField ? shippingCompanyIdField.value : "";

                if (persistedShippingIdValue) {
                    const restoredData = {
                        company_name: persistedShippingValue,
                        company_id: persistedShippingIdValue
                    };
                    hyva.getBrowserStorage().setItem('shipping_company_selection', JSON.stringify(restoredData));
                    updatePaymentFields(persistedShippingValue, persistedShippingIdValue);
                    paymentFieldsInitialized = true;
                }
            }
        };

        // Use MutationObserver to watch for payment form elements
        const observeForPaymentForm = () => {
            if (paymentFieldsInitialized) return;

            const companyNameInput = document.querySelector('[data-name="company_name"]');
            const companyIdInput = document.querySelector('[data-name="company_id"]');

            if (companyNameInput && companyIdInput) {
                // Payment form is already ready, initialize immediately
                initializePaymentFieldsFromShipping();
                paymentFieldsInitialized = true;

                // Check if two_payment is already selected on page load and trigger order intent if needed
                const activePaymentMethod = document.querySelector('input[name="payment-method-option"]:checked');
                if (activePaymentMethod && activePaymentMethod.value === "two_payment") {
                    const shippingCompanySelectionData = JSON.parse(hyva.getBrowserStorage().getItem('shipping_company_selection') || "{}");
                    if (shippingCompanySelectionData.company_name && shippingCompanySelectionData.company_id) {
                        window.dispatchEvent(new Event("dispatch-order-intent"));
                    }
                }
                return;
            }

            // Set up MutationObserver to watch for payment form elements
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList') {
                        const companyNameInput = document.querySelector('[data-name="company_name"]');
                        const companyIdInput = document.querySelector('[data-name="company_id"]');

                        if (companyNameInput && companyIdInput) {
                            initializePaymentFieldsFromShipping();
                            paymentFieldsInitialized = true;

                            // Check if two_payment is already selected and trigger order intent
                            const activePaymentMethod = document.querySelector('input[name="payment-method-option"]:checked');
                            if (activePaymentMethod && activePaymentMethod.value === "two_payment") {
                                const shippingCompanySelectionData = JSON.parse(hyva.getBrowserStorage().getItem('shipping_company_selection') || "{}");
                                if (shippingCompanySelectionData.company_name && shippingCompanySelectionData.company_id) {
                                    window.dispatchEvent(new Event("dispatch-order-intent"));
                                }
                            }
                            observer.disconnect(); // Stop observing once we've found the elements
                        }
                    }
                });
            });

            // Start observing the document for changes
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        };

        // Start observing for payment form
        observeForPaymentForm();
    });


    /** Listen for the event that triggers when a payment method is activated during checkout */
    window.addEventListener("checkout:payment:method-activate", (event) => {
        const paymentMethod = event.detail.method;

        /** Check if the selected payment method is "two_payment" */
        if (paymentMethod === "two_payment") {
            /** Initialize payment method but don't overwrite existing company data */
            /** The company data should only be updated by shipping section selections */

            /** Retrieve previously saved company details to check if order intent should be dispatched */
            const shippingCompanySelectionData = JSON.parse(hyva.getBrowserStorage().getItem('shipping_company_selection') || "{}");
            const alreadySavedCompanyDetails = JSON.parse(hyva.getBrowserStorage().getItem('already_saved_company_details') || "{}");

            const shippingCompany = shippingCompanySelectionData.company_name || "";
            const shippingCompanyId = shippingCompanySelectionData.company_id || "";
            const savedShippingCompany = alreadySavedCompanyDetails.company_name || "";
            const savedShippingCompanyId = alreadySavedCompanyDetails.company_id || "";

            /** If we have shipping company data but payment fields are empty, populate them */
            if (shippingCompany && shippingCompanyId) {
                const companyNameInput = document.querySelector('[data-name="company_name"]');
                const companyIdInput = document.querySelector('[data-name="company_id"]');

                if (companyNameInput && companyIdInput && !companyNameInput.value) {
                    // Use the centralized update function for consistency and Alpine.js sync
                    updatePaymentFields(shippingCompany, shippingCompanyId);
                    paymentFieldsInitialized = true; // Mark as initialized to prevent duplicates
                }
            }

            // Trigger order intent if we have company data
            if (shippingCompany && shippingCompanyId) {
                window.dispatchEvent(new Event("dispatch-order-intent"));
            }
        }
    });


    /** Listen for shipping company selection events to update payment fields */
    window.addEventListener("shipping-company-selected", (event) => {
        // Only sync if billing is same as shipping
        if (!isBillingAsShipping()) {
            return;
        }

        /** Retrieve the latest shipping company selection data */
        const shippingCompanySelectionData = JSON.parse(hyva.getBrowserStorage().getItem('shipping_company_selection') || "{}");
        const shippingCompany = shippingCompanySelectionData.company_name || "";
        const shippingCompanyId = shippingCompanySelectionData.company_id || "";

        if (shippingCompany !== "" && shippingCompanyId !== "") {
            /** Update payment method fields with shipping selection */
            const companyNameInput = document.querySelector('[data-name="company_name"]');
            const companyIdInput = document.querySelector('[data-name="company_id"]');

            if (companyNameInput && companyIdInput) {
                // Check if two_payment method is active for order intent
                const activePaymentMethod = document.querySelector('input[name="payment-method-option"]:checked');
                const shouldTriggerOrderIntent = activePaymentMethod && activePaymentMethod.value === "two_payment";

                // Use the centralized update function for consistency and Alpine.js sync
                updatePaymentFields(shippingCompany, shippingCompanyId, shouldTriggerOrderIntent, true);
            }
        }
    });

    /**
     * Listen for Hyva Checkout's billing_as_shipping_address_updated Magewire event.
     * When user toggles the "billing same as shipping" checkbox, we need to
     * sync or clear payment company fields accordingly.
     */
    document.addEventListener('DOMContentLoaded', () => {
        // Wait for Magewire to be available, then register event listener
        const registerMagewireListener = () => {
            if (typeof Magewire !== 'undefined' && Magewire.on) {
                Magewire.on('billing_as_shipping_address_updated', (data) => {
                    const billingAsShipping = data?.billingAsShipping;

                    if (billingAsShipping) {
                        // Billing is now same as shipping - sync company data from shipping
                        const shippingCompanySelectionData = JSON.parse(hyva.getBrowserStorage().getItem('shipping_company_selection') || "{}");
                        const shippingCompany = shippingCompanySelectionData.company_name || "";
                        const shippingCompanyId = shippingCompanySelectionData.company_id || "";

                        if (shippingCompany && shippingCompanyId) {
                            updatePaymentFields(shippingCompany, shippingCompanyId, false, true);
                        }
                    }
                    // When billingAsShipping is false, let the user enter their own billing company
                });
            } else {
                // Retry after a short delay if Magewire is not ready
                setTimeout(registerMagewireListener, 100);
            }
        };

        registerMagewireListener();
    });
</script>
<?php $hyvaCsp->registerInlineScript(); ?>
