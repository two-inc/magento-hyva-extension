<?php

/**
 * Copyright Â© Two.inc All rights reserved.
 * See COPYING.txt for license details.
 */

declare(strict_types=1);

use Hyva\Theme\ViewModel\HyvaCsp;

/** @var HyvaCsp $hyvaCsp */
?>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        /**
         * Reset the stored event flag in browser storage.
         * This ensures that any previously set event listener flag is cleared.
         * This is useful when reloading or reinitializing the payment method,
         * preventing stale data from affecting event handling.
         */
        hyva.getBrowserStorage().setItem('two-payment-method-event-set', '');

        /**
         * Clear previously saved company details.
         * This prevents outdated company information from persisting across sessions or reloads.
         * An empty object `{}` is stored in JSON format to maintain structure.
         */
        hyva.getBrowserStorage().setItem('already_saved_company_details', JSON.stringify({}));
    });


    /** Listen for the event that triggers when a payment method is activated during checkout */
    window.addEventListener("checkout:payment:method-activate", (event) => {
        const paymentMethod = event.detail.method;

        /** Check if the selected payment method is "two_payment" */
        if (paymentMethod === "two_payment") {
            /** Retrieve selected shipping company details from browser storage */
            const shippingCompanySelectionData = JSON.parse(hyva.getBrowserStorage().getItem('shipping_company_selection') || "{}");
            const shippingCompany = shippingCompanySelectionData.company_name || "";
            const shippingCompanyId = shippingCompanySelectionData.company_id || "";

            /** If valid company details exist, proceed to populate the fields */
            if (shippingCompany !== "" && shippingCompanyId !== "") {
                setTimeout(() => {
                    /** Select the company name and company ID input fields using data attributes */
                    const companyNameInput = document.querySelector('[data-name="company_name"]');
                    const companyIdInput = document.querySelector('[data-name="company_id"]');

                    if (companyNameInput && companyIdInput) {
                        /** Retrieve previously saved company details from storage */
                        const alreadySavedCompanyDetails = JSON.parse(hyva.getBrowserStorage().getItem('already_saved_company_details') || "{}");
                        const savedShippingCompany = alreadySavedCompanyDetails.company_name || "";
                        const savedShippingCompanyId = alreadySavedCompanyDetails.company_id || "";

                        /** Set the input field values based on retrieved company details */
                        companyNameInput.value = shippingCompany;
                        companyIdInput.disabled = false;
                        companyIdInput.value = shippingCompanyId;
                        companyIdInput.disabled = true;
                        companyIdInput.style.backgroundColor = "#D3D3D3";

                        /** Update the already saved company details in storage */
                        const updatedCompanyDetails = {
                            company_name: shippingCompany,
                            company_id: shippingCompanyId
                        };

                        /** Store the updated company details in browser storage as a JSON string */
                        hyva.getBrowserStorage().setItem('already_saved_company_details', JSON.stringify(updatedCompanyDetails));

                        /** Dispatch the "dispatch-order-intent" event if the company details have changed */
                        if (shippingCompany !== savedShippingCompany || shippingCompanyId !== savedShippingCompanyId) {
                            window.dispatchEvent(new Event("dispatch-order-intent"));
                        }
                    }
                }, 200);
            }
        }
    });
</script>
<?php $hyvaCsp->registerInlineScript(); ?>
