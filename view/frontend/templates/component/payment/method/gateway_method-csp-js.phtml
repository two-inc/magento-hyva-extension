<?php

/**
 * Hyvä Themes - https://hyva.io
 * Copyright © Hyvä Themes 2020-present. All rights reserved.
 * This product is licensed per Magento install
 * See https://hyva.io/license
 */

declare(strict_types=1);

use Two\GatewayHyva\ViewModel\CheckoutConfig;
use Two\GatewayHyva\ViewModel\GetQuoteDetails;
use Hyva\Theme\Model\ViewModelRegistry;
use Magento\Framework\Escaper;
use Hyva\Theme\ViewModel\HyvaCsp;

/** @var ViewModelRegistry $viewModels */
/** @var CheckoutConfig $viewModel */
/** @var Escaper $escaper */
/** @var HyvaCsp $hyvaCsp */

$configModel = $viewModels->require(CheckoutConfig::class);
$quoteModel = $viewModels->require(GetQuoteDetails::class);

$checkoutApiUrl = $configModel->getCheckoutApiUrl();
$companySearchLimit = $configModel->getCompanySearchLimit();
$isOrderIntentEnabled = $configModel->getIsOrderIntentEnabled();
$orderIntentApprovedMessage = $configModel->getOrderIntentApprovedMessage();
$orderIntentDeclinedMessage = $configModel->getOrderIntentDeclinedMessage();
$generalErrorMessage = $configModel->getGeneralErrorMessage();
$orderIntentConfig = $configModel->getOrderIntentConfig();
$checkoutPageUrl = $configModel->getCheckoutPageUrl();
$merchantDetails = $orderIntentConfig["merchant"] ?? [];
$merchantId = $merchantDetails["id"] ?? "";
$merchantName = $merchantDetails["short_name"] ?? "";

$quoteDetails = $quoteModel->getQuoteDetails();
$quoteDetails = json_encode($quoteDetails);

/** Generated with hyva-csp-helper.php */
?>
<script>
    function validatePaymentForm(form, wire) {
        let timeout = null;
        let dirty = false;

        return Object.assign({},
            hyva.formValidation(form), {
                init() {
                    const doSave = async (isWithValidation = true) => {
                        clearTimeout(timeout);

                        if (isWithValidation) {
                            try {
                                await this.validate();
                            } catch (error) {
                                console.error("Form validation failed:", error);
                                return;
                            }
                        }
                        if (this.isOrderIntentEnabled) {
                            const activePaymentMethod = document.querySelector('input[name="payment-method-option"]:checked');

                            if (activePaymentMethod) {
                                const selectedPaymentValue = activePaymentMethod.value;
                                const isTwoPaymentSelected = selectedPaymentValue === "two_payment";

                                if (isTwoPaymentSelected) {
                                    const formRef = form;

                                    window.dispatchEvent(new Event("dispatch-order-intent"));

                                    await new Promise((resolve, reject) => {
                                        const timeoutId = setTimeout(() => {
                                            reject("Order intent operation timed out");
                                        }, 5000);

                                        const checkAndProceed = () => {
                                            try {
                                                const formElements = [
                                                    'department',
                                                    'project',
                                                    'poNumber',
                                                    'orderNote',
                                                    'invoiceEmails',
                                                    'company_name',
                                                    'company_id'
                                                ];

                                                const paymentData = {
                                                    additionalData: Object.fromEntries(
                                                        formElements.map(field => {
                                                            const element = formRef.querySelector(`[name="payment[${field}]"]`);
                                                            return [field === 'company_name' ? 'companyName' : field === 'company_id' ? 'companyId' : field, element?.value || ""];
                                                        })
                                                    )
                                                };

                                                paymentData.additionalData.organization_number = paymentData.additionalData.companyId;

                                                Magewire.find("checkout.payment.method.two-payment-method")
                                                    .call('setPaymentData', paymentData)
                                                    .then(() => {
                                                        clearTimeout(timeoutId);
                                                        resolve();
                                                    })
                                                    .catch((error) => {
                                                        console.error("Error setting payment data:", error);
                                                        clearTimeout(timeoutId);
                                                        resolve();
                                                    });

                                            } catch (error) {
                                                console.error("Error in payment data processing:", error);
                                                clearTimeout(timeoutId);
                                                resolve();
                                            }
                                        };

                                        setTimeout(checkAndProceed, 1000);
                                    });
                                }
                            }
                        }

                        try {
                            if (!dirty) {
                                return;
                            }

                            dirty = false;
                            await wire.store();
                        } catch (exception) {
                            console.error("Error in wire.store():", exception);
                        }

                    }

                    const interactionCallback = () => {
                        dirty = true;

                        clearTimeout(timeout);

                        try {
                            timeout = setTimeout(() => {
                                doSave(false);
                            }, wire.autoSaveTimeout);
                        } catch (error) {
                            console.error("Error in interactionCallback setTimeout:", error);
                        }
                    }

                    hyvaCheckout.navigation.addTask(doSave, {
                        name: 'two-payment-method'
                    });

                    const addEventListeners = (el) => {
                        if (el !== form) return;

                        this.$nextTick(() => {
                            Array.from(form.querySelectorAll('[wire\\:auto-save]')).forEach(field => {
                                ['input', 'change'].map(eventName => {
                                    field.removeEventListener(eventName, interactionCallback);
                                    field.addEventListener(eventName, interactionCallback);
                                })
                            })
                        })
                    }

                    addEventListeners(form);
                    Magewire.hook('element.updated', addEventListeners);
                }
            }
        )
    }

    function twoGatewayHyvaPaymentMethodBase() {
        return {
            // State
            isOpen: false,
            search: '',
            items: [],
            companyName: '',
            companyId: '',
            invoiceEmails: '',
            project: '',
            department: '',
            orderNote: '',
            poNumber: '',
            manualMode: false,
            isSelecting: false,
            isPaymentTermsAccepted: false,
            selectedIndex: -1,
            searchTimeout: '',
            countryCode: '',
            placeOrderIntentFlag: true,

            // Config from PHP
            isProjectFieldEnabled: '<?= $configModel->getIsProjectFieldEnabled() ?>',
            isDepartmentFieldEnabled: '<?= $configModel->getIsDepartmentFieldEnabled() ?>',
            isOrderNoteFieldEnabled: '<?= $configModel->getIsOrderNoteFieldEnabled() ?>',
            isPONumberFieldEnabled: '<?= $configModel->getIsPONumberFieldEnabled() ?>',
            isPaymentTermsEnabled: '<?= $configModel->getIsPaymentTermsEnabled() ?>',
            isInvoiceEmailsEnabled: '<?= $configModel->getIsInvoiceEmailsEnabled() ?>',
            checkoutApiUrl: '<?= $checkoutApiUrl ?>',
            companySearchLimit: '<?= $companySearchLimit ?>',
            isOrderIntentEnabled: '<?= $isOrderIntentEnabled ?>',
            orderIntentApprovedMessage: '<?= $escaper->escapeJs(
                __($orderIntentApprovedMessage),
            ) ?>',
            orderIntentDeclinedMessage: '<?= $escaper->escapeJs(
                __($orderIntentDeclinedMessage),
            ) ?>',
            generalErrorMessage: '<?= $escaper->escapeJs(
                __($generalErrorMessage),
            ) ?>',
            orderIntentConfig_weightUnit: '<?= $orderIntentConfig[
                "weightUnit"
            ] ?>',
            orderIntentConfig_merchant_id: '<?= $merchantId ?>',
            orderIntentConfig_merchant_shortName: '<?= $merchantName ?>',
            orderIntentConfig_extensionPlatformName: '<?= $orderIntentConfig[
                "extensionPlatformName"
            ] ?>',
            orderIntentConfig_extensionDBVersion: '<?= $orderIntentConfig[
                "extensionDBVersion"
            ] ?>',
            quote: '<?= $quoteDetails ?>',
            checkoutPageUrl: '<?= $escaper->escapeUrl(__($checkoutPageUrl)) ?>',

            // CSP-friendly event handlers (called from template)
            twoGatewayHyvaOnInit() {
                this.initialize(JSON.parse(this.$el.dataset.hyvacsp1));
            },
            twoGatewayHyvaOnInvoiceEmailsChange() {
                this.invoiceEmails = this.$el.value;
            },
            twoGatewayHyvaOnProjectChange() {
                this.project = this.$el.value;
            },
            twoGatewayHyvaOnDepartmentChange() {
                this.department = this.$el.value;
            },
            twoGatewayHyvaOnOrderNoteChange() {
                this.orderNote = this.$el.value;
            },
            twoGatewayHyvaOnPoNumberChange() {
                this.poNumber = this.$el.value;
            },
            twoGatewayHyvaOnPaymentTermsChange() {
                this.isPaymentTermsAccepted = this.$el.checked;
            },
            twoGatewayHyvaOnCompanySearchClickOutside() {
                this.isOpen = false;
            },
            twoGatewayHyvaOnCompanySearchFocus() {
                if (!this.manualMode) this.isOpen = true;
            },
            twoGatewayHyvaOnArrowDown() {
                this.nextItem();
            },
            twoGatewayHyvaOnArrowUp() {
                this.prevItem();
            },
            twoGatewayHyvaOnEnterSelect() {
                this.selectHighlightedItem();
            },
            twoGatewayHyvaOnItemMouseover(event) {
                this.selectedIndex = parseInt(event.currentTarget.dataset.index);
            },
            twoGatewayHyvaShouldShowMinCharsMessage() {
                return this.search.length < 3;
            },

            // Computed-style methods
            showDropdown() {
                return this.isOpen && this.items.length > 0 && !this.manualMode;
            },
            getCompanyNamePlaceholder() {
                return this.manualMode ? '' : '<?= $escaper->escapeJs(
                    __("Enter company name to search"),
                ) ?>';
            },
            isCompanyIdDisabled() {
                return !this.manualMode;
            },
            getCompanyIdStyle() {
                return !this.manualMode ? 'background-color: #D3D3D3' : '';
            },

            // Initialization
            initialize(quote) {
                this.quote = quote;
                this.manualMode = false;
                twoPaymentComponentInstance = this;

                this.$el.addEventListener('update-company-data', (event) => {
                    this.search = event.detail.companyName;
                    this.companyName = event.detail.companyName;
                    this.companyId = event.detail.companyId;
                });

                this.$nextTick(() => {
                    const shippingCompanySelectionData = JSON.parse(hyva.getBrowserStorage().getItem('shipping_company_selection') || "{}");
                    const shippingCompany = shippingCompanySelectionData.company_name || "";

                    if (!shippingCompany) {
                        this.search = document.getElementById('company_name')?.value ?? '';
                    } else {
                        this.search = shippingCompany;
                        this.fillCompanyData(shippingCompanySelectionData.company_id || "", shippingCompany, false);
                    }
                });
            },

            // Company search methods
            async getItems() {
                if (this.isSelecting) { this.isSelecting = false; return; }
                if (this.manualMode) return;

                this.search = this.$el.value;
                this.selectedIndex = -1;
                const quoteData = JSON.parse(JSON.stringify(this.quote));
                const countryId = document.getElementById("shipping-country_id");

                this.countryCode = countryId?.value || quoteData.country_id;

                if (!this.countryCode) {
                    window.dispatchMessages([{ type: 'error', text: this.countrySelection }], 3000);
                    return;
                }

                clearTimeout(this.searchTimeout);
                if (this.search.length < 3) {
                    this.items = [];
                    return;
                }

                this.searchTimeout = setTimeout(async () => {
                    window.dispatchEvent(new Event('magewire:loader:start'));
                    try {
                        const queryParams = new URLSearchParams({
                            country: this.countryCode.toUpperCase(),
                            limit: this.companySearchLimit,
                            offset: 0,
                            q: unescape(this.search),
                        });

                        const response = await fetch(this.checkoutApiUrl + '/companies/v2/company?' + queryParams);
                        if (!response.ok) throw new Error("Network response was not ok");

                        const data = await response.json();
                        this.items = data.items.map(item => ({
                            companyName: item.name,
                            companyDisplayName: `${item.highlight} (${item.national_identifier.id})`,
                            companyId: item.national_identifier.id,
                            lookupId: item.lookup_id,
                            item: item
                        }));

                        if (this.items.length > 0) this.isOpen = true;
                    } catch (error) {
                        console.error("Error fetching companies:", error);
                        this.items = [];
                    }
                    window.dispatchEvent(new Event('magewire:loader:done'));
                }, 200);
            },

            handleItemClick(event) {
                const index = event.currentTarget.dataset.index;
                if (index !== undefined && this.items[index]) {
                    this.selectItem(this.items[index]);
                }
            },

            selectItem(item) {
                this.isSelecting = true;
                this.isOpen = false;
                this.items = [];
                this.selectedIndex = -1;
                this.search = item.companyName;

                hyva.getBrowserStorage().setItem('shipping_company_selection', JSON.stringify({
                    company_name: item.companyName,
                    company_id: item.companyId
                }));

                this.fillCompanyData(item.companyId, item.companyName);
            },

            enterManually() {
                this.manualMode = true;
                this.isOpen = false;
                this.items = [];
                const companyIdInput = document.getElementById("company_id");
                if (companyIdInput) {
                    companyIdInput.disabled = false;
                    companyIdInput.style.backgroundColor = "";
                }
            },

            enableSearch() {
                this.manualMode = false;
                document.getElementById('company_name')?.focus();
            },

            // Keyboard navigation
            nextItem() {
                if (this.selectedIndex < this.items.length - 1) {
                    this.selectedIndex++;
                    this.adjustScroll();
                }
            },

            prevItem() {
                if (this.selectedIndex > 0) {
                    this.selectedIndex--;
                    this.adjustScroll();
                }
            },

            adjustScroll() {
                this.$nextTick(() => {
                    const dropdown = document.querySelector(".company-results");
                    const selectedItem = document.querySelectorAll("div.cursor-pointer")[this.selectedIndex];

                    if (dropdown && selectedItem) {
                        const dropdownRect = dropdown.getBoundingClientRect();
                        const itemRect = selectedItem.getBoundingClientRect();

                        if (itemRect.bottom > dropdownRect.bottom) {
                            dropdown.scrollTop += itemRect.bottom - dropdownRect.bottom;
                        } else if (itemRect.top < dropdownRect.top) {
                            dropdown.scrollTop -= dropdownRect.top - itemRect.top;
                        }
                    }
                });
            },

            selectHighlightedItem() {
                if (this.selectedIndex >= 0 && this.items.length > 0) {
                    this.selectItem(this.items[this.selectedIndex]);
                }
            },

            closeCompanyList(event) {
                if (event.key === 'Tab') {
                    this.isOpen = false;
                    this.items = [];
                }
            },

            fillCompanyData(companyId = '', companyName = '', triggerOrderIntent = true) {
                companyName = typeof companyName === 'string' && companyName ? companyName : '';
                companyId = typeof companyId === 'string' ? companyId : '';
                if (!companyId || !companyName) return;

                this.companyName = companyName;
                this.companyId = companyId;

                const companyNameInput = document.getElementById("company_name");
                if (companyNameInput) companyNameInput.value = companyName;

                const companyIdInput = document.getElementById("company_id");
                if (companyIdInput) {
                    companyIdInput.disabled = false;
                    companyIdInput.value = companyId;
                    if (!this.manualMode) {
                        companyIdInput.disabled = true;
                        companyIdInput.style.backgroundColor = "#D3D3D3";
                    }
                }

                if (this.isOrderIntentEnabled && triggerOrderIntent) {
                    window.dispatchEvent(new Event("dispatch-order-intent"));
                }
            },

            // Order Intent methods
            async placeOrderIntent() {
                try {
                    const quoteData = JSON.parse(JSON.stringify(this.quote));

                    if (this.shouldSkipOrderIntent(quoteData)) return null;

                    const orderIntentRequestBody = this.buildOrderIntentRequestBody(quoteData);
                    const queryParams = new URLSearchParams({
                        client: this.orderIntentConfig_extensionPlatformName,
                        client_v: this.orderIntentConfig_extensionDBVersion
                    });

                    const response = await fetch(`${this.checkoutApiUrl}/v1/order_intent?${queryParams.toString()}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(orderIntentRequestBody)
                    });

                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    console.error('Error in placeOrderIntent:', error);
                    throw error;
                }
            },

            shouldSkipOrderIntent(quoteData) {
                // Check both component state and DOM for manual entry support
                const companyIdInput = document.getElementById("company_id");
                const companyId = this.companyId || companyIdInput?.value || '';
                return !companyId.trim();
            },

            buildOrderIntentRequestBody(quoteData) {
                // Read from DOM to support manual entry (component state only set for dropdown selection)
                const companyNameInput = document.getElementById("company_name");
                const companyIdInput = document.getElementById("company_id");
                const companyName = this.companyName || companyNameInput?.value || "";
                const companyId = this.companyId || companyIdInput?.value || "";

                let lineItems = quoteData.items?.map(item => ({
                    name: item.name,
                    description: item.description || '',
                    discount_amount: parseFloat(item.discount_amount || 0).toFixed(2),
                    gross_amount: parseFloat(item.row_total_incl_tax || 0).toFixed(2),
                    net_amount: parseFloat(item.row_total || 0).toFixed(2),
                    quantity: item.qty,
                    unit_price: parseFloat(item.price || 0).toFixed(2),
                    tax_amount: parseFloat(item.tax_amount || 0).toFixed(2),
                    tax_rate: (parseFloat(item.tax_percent || 0) / 100).toFixed(6),
                    tax_class_name: '',
                    quantity_unit: this.orderIntentConfig_weightUnit || '',
                    image_url: item.thumbnail,
                    type: item.is_virtual === '0' ? 'PHYSICAL' : 'DIGITAL'
                })) || [];

                lineItems.push({
                    name: 'Shipping',
                    description: 'Shipping fee',
                    gross_amount: parseFloat(quoteData.shipping_incl_tax || 0).toFixed(2),
                    net_amount: parseFloat(quoteData.shipping_amount || 0).toFixed(2),
                    quantity: 1,
                    unit_price: parseFloat(quoteData.shipping_amount || 0).toFixed(2),
                    tax_amount: parseFloat(quoteData.shipping_tax_amount || 0).toFixed(2),
                    tax_rate: isNaN(parseFloat(quoteData.shipping_tax_amount)) || isNaN(parseFloat(quoteData.shipping_amount)) || parseFloat(quoteData.shipping_amount) === 0
                        ? "0.000000"
                        : (parseFloat(quoteData.shipping_tax_amount) / parseFloat(quoteData.shipping_amount)).toFixed(6),
                    tax_class_name: '',
                    quantity_unit: 'unit',
                    type: 'SHIPPING_FEE'
                });

                const countryInput = document.getElementById("shipping-country_id");
                this.countryCode = countryInput?.value || quoteData.country_id;

                const gross_amount = parseFloat(quoteData.grand_total || 0);
                const tax_amount = parseFloat(quoteData.tax_amount) + parseFloat(quoteData.shipping_tax_amount);
                const net_amount = gross_amount - tax_amount;

                return {
                    gross_amount: gross_amount.toFixed(2),
                    net_amount: net_amount.toFixed(2),
                    tax_amount: tax_amount.toFixed(2),
                    currency: quoteData.quote_currency_code,
                    line_items: lineItems,
                    buyer: {
                        company: {
                            organization_number: companyId,
                            country_prefix: this.countryCode,
                            company_name: companyName
                        },
                        representative: {
                            email: quoteData.email,
                            first_name: quoteData.first_name,
                            last_name: quoteData.last_name,
                            phone_number: quoteData.telephone
                        }
                    },
                    merchant_id: this.orderIntentConfig_merchant_id,
                    merchant_short_name: this.orderIntentConfig_merchant_shortName
                };
            },

            processOrderIntentSuccessResponse(response) {
                if (!response) return;

                if (response.approved) {
                    this.placeOrderIntentFlag = true;
                    window.dispatchMessages([{ type: 'success', text: this.orderIntentApprovedMessage }], 3000);
                } else {
                    this.placeOrderIntentFlag = false;
                    window.dispatchMessages([{ type: 'error', text: this.orderIntentDeclinedMessage }], 3000);
                }
            },

            processOrderIntentErrorResponse(response) {
                this.placeOrderIntentFlag = false;
                let message = this.generalErrorMessage;

                if (response?.responseJSON) {
                    const { error_code, error_message, error_details, error_json } = response.responseJSON;

                    switch (error_code) {
                        case 'SCHEMA_ERROR':
                            if (error_json) {
                                message = '';
                                error_json.forEach(error => {
                                    window.dispatchMessages([{ type: 'error', text: error.msg }], 3000);
                                });
                            }
                            break;
                        case 'JSON_MISSING_FIELD':
                            if (error_details) message = error_details;
                            break;
                        case 'MERCHANT_NOT_FOUND_ERROR':
                        case 'ORDER_INVALID':
                            message = error_message + (error_details ? ' - ' + error_details : '');
                            break;
                    }
                }

                if (message) {
                    window.dispatchMessages([{ type: 'error', text: message }], 3000);
                }
            },
        };
    }

    function twoGatewayHyvaPaymentFormWithValidation() {
        return {
            ...twoGatewayHyvaPaymentMethodBase(),
            ...validatePaymentForm(this.$el, this.$wire)
        };
    }

    function twoGatewayHyvaPaymentTermsComponent() {
        return twoGatewayHyvaPaymentMethodBase();
    }

    document.addEventListener('alpine:init', () => {
        Alpine.data('twoGatewayHyvaPaymentMethodBase', twoGatewayHyvaPaymentMethodBase);
        Alpine.data('twoGatewayHyvaPaymentFormWithValidation', twoGatewayHyvaPaymentFormWithValidation);
        Alpine.data('twoGatewayHyvaPaymentTermsComponent', twoGatewayHyvaPaymentTermsComponent);
    });

    // Global reference to the payment component instance
    let twoPaymentComponentInstance = null;

    // Debounce timeout for order intent
    let orderIntentDebounceTimeout = null;

    // Global order intent event listener - only added once
    // Uses debouncing to prevent multiple rapid calls
    window.addEventListener("dispatch-order-intent", (event) => {
        if (orderIntentDebounceTimeout) {
            clearTimeout(orderIntentDebounceTimeout);
        }

        orderIntentDebounceTimeout = setTimeout(() => {
            const activePaymentMethod = document.querySelector('input[name="payment-method-option"]:checked');

            if (!activePaymentMethod) {
                return;
            }

            const selectedPaymentValue = activePaymentMethod.value;
            const isTwoPaymentSelected = selectedPaymentValue === "two_payment";

            if (!isTwoPaymentSelected) {
                return;
            }

            const executeOrderIntent = () => {
                if (!twoPaymentComponentInstance) {
                    return false;
                }

                if (!twoPaymentComponentInstance.isOrderIntentEnabled) {
                    return false;
                }

                twoPaymentComponentInstance.placeOrderIntent()
                    .then(response => twoPaymentComponentInstance.processOrderIntentSuccessResponse(response))
                    .catch(error => twoPaymentComponentInstance.processOrderIntentErrorResponse(error));
                return true;
            };

            if (!executeOrderIntent()) {
                setTimeout(() => {
                    executeOrderIntent();
                }, 100);
            }
        }, 300);
    });
</script>
<?php $hyvaCsp->registerInlineScript(); ?>
